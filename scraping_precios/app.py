import streamlit as st
import pandas as pd
import requests
from datetime import datetime

# -------------------
# üîπ COOKIE de Hiper Olivos
# -------------------
COOKIE_SEGMENT = "eyJjYW1wYWlnbnMiOm51bGwsImNoYW5uZWwiOiIxIiwicHJpY2VUYWJsZXMiOm51bGwsInJlZ2lvbklkIjpudWxsLCJ1dG1fY2FtcGFpZ24iOm51bGwsInV0bV9zb3VyY2UiOm51bGwsInV0bWlfY2FtcGFpZ24iOm51bGwsImN1cnJlbmN5Q29kZSI6IkFSUyIsImN1cnJlbmN5U3ltYm9sIjoiJCIsImNvdW50cnlDb2RlIjoiQVJHIiwiY3VsdHVyZUluZm8iOiJlcy1BUiIsImFkbWluX2N1bHR1cmVJbmZvIjoiZXMtQVIiLCJjaGFubmVsUHJpdmFjeSI6InB1YmxpYyJ9"

HEADERS = {
    "User-Agent": "Mozilla/5.0",
    "Cookie": f"vtex_segment={COOKIE_SEGMENT}"
}

# -------------------
# üîπ Diccionario de productos (Nombre: productId)
# -------------------
productos = {
    "ANILLOS CLASICOS 24X170G": "7622201808884",
    "ANILLOS CLASICOS 24X300G": "7622201504007",
    "BOCA DE DAMA 20X170G": "7622201808860",
    "CEREALITAS TOSTADAS ARROZ 24 x 160 GRS.": "7622300160975",
    "CLUB SC JAMON 44MPX6UNX23,5G NEW": "7622210692245",
    "CLUB ORIGINAL 44PKX6UNX24G VSA SC": "7622300990732",
    "DUQUESA TOONIX 36 PQ. X 115 GR": "7622300742645",
    "DUQUESA 12X345G ": "7622202218729",
    "MELBA 12X360G TRIPACK": "7794600004539",
    "MELBA ANGRY BIRDS 36X120G": "7622300829728",
    "GALLETA MILKA VAI 36X124G": "7622202210051",
    "GALLETA MILKA CHOCO 36X124G": "7622202210075",
    "MINI OREO 54X50G ": "7622201761288",
    "OREO GOLDEN QI 12X354G": "7622201806538",
    "OREO GOLDEN QI 36X118G": "7622201806552",
    "OREO REGULAR 42X182,5G": "7622201735821",
    "OREO REG SINGLE 36X118G": "7622201735296",
    "OREO MILKSHAKE FRU 36X118G L13": "7622202049057",
    "OREO REG TRIPACK 12X354G": "7622201735258",
    "OREO MAN√ç 36X118G L13 ": "7622202302862",
    "PEPITOS REG SINGLE 60X119G": "7622201735906",
    "TERRA CCC 24X144G ": "7622201385279",
    "TERRABUSI SCONS 36X160G": "7622201491611",
    "GALLETA TERRABUSI VAINILLA 60X120G": "7622202220555",
    "GALLETA TERRABUSI MIEL 60X120G": "7622202220579",
    "MINI PEPITOS 54X50G": "7622201740399",
    "PEPITOS REG TRIPACK 20X357G": "7622201735883",
    "LINCOLN CLASICAS 2023 PN 60X153G": "7622201386719",
    "LINCOLN CLASICAS 2023 60X153G": "7622201386719",
    "LINCOLN CLASICA TRIPACK 2023 20X459": "7622201745547",
    "LINCOLN CHOCO 60X153G": "7622300742676",
    "LINCOLN COCO 60X153G": "7622300742713",
    "VARIEDAD NUEVO MIX 2023 16X590G": "7622201745585",
    "CEREALITAS ARROZ RS 24X160G": "7622201753061",
    "OREO CHOCO 36X118G L13": "7622202049033",
    "OREO CHOCO 36X118G": "7622201735845",
    "VARIEDAD CHOCO 24X300G": "7622201503987",
    "VARIEDAD DORADA 24X300G": "7622201503963",
    "LINCOLN CLASICAS 2023 36X219G": "7622201735319",
    "MANON L7 45X182G": "7622201385255",
    "OREO REG 36X118G L16": "7622201735272",
    "VARIEDAD NUEVO MIX 2023 36X170G": "7622201745639",
    "VARIEDAD NUEVO MIX 2023 20X390G": "7622201745561",
    "OREO BANADAS CHOCO 16X119G": "7622201740375",
    "OREO BANADAS BCO 16X119G": "7622201745615",
    "OREO SIN TACC 24X95G": "7622202038099",
    "MINI OREO WE 12X150G": "7622202219337",
    "CEREALITAS AVENA CACAO24 48X170G": "7622202241505",
    "CEREALITAS GRANOLA24 48X170G": "7622202241567",
    "CEREALITAS SALVADO X3 15X624G ": "7622201746032",
    "CEREALITAS SALVADO 45X208G": "7622201745981",
    "CEREALITAS CLASICAS X3 15X636G": "7622201745905",
    "CEREALITAS CLASICAS 45X212G": "7622201736033",
    "BUBBA GOMITA C BLUEBERRY 14X82,5GR": "7622202216473",
    "BUBBA GOMITA FRUTILLA CIT 14X82,5GR": "7622202216510",
    "BUBBA GOMITA FRUTILLA 12DX12UX15G": "7622202216589",
    "BUBBA GOMITA MIX CIT 12DX12UX16,5G": "7622202217265",
    "BUBBA GOMITA FRUTILLA CIT 12DX12UX16,5G": "7622202217296",
    "BUBBA CRACKUPS  18X18X24G": "7622202228490",
    "BUBBA CRACKUPS  12X12X72G": "7622202228469",
    "CARAMELOS CLIGHT NARANJA 18X12": "7622300803698",
    "CAR.CLIGHT FRAMBUESA": "7622300835194",
    "CAR HALLS XTRA STRONG 24X12": "77986283",
    "CAR HALLS SANDIA 24X12X28g": "77987679",
    "CAR HALLS MENTHO 24X12X28g": "77987655",
    "CAR HALLS SANDIA 30X12X25.2G": "7622202247361",
    "CAR HALLS CHERRY 30X12X25.2G": "7622202247286",
    "CAR HALLS MENTALYPTUS 30X12X25.2G": "7622202247316",
    "CAR HALLS MENTHO 30X12X25.2G": "7622202247392",
    "HALLS STANI MIEL C/LIMON 24X12X28GR": "77905277",
    "HALLS STANI MIEL C/MENTA 24X12X28GR": "77905291",
    "CAR. HALLS VITA C FRUTILLA 24x12 D11": "77917317",
    "CAR. HALLS VITA C NARANJA 24x12 D11": "77917324",
    "CAR HALLS CHERRY 24X12X28g": "77987662",
    "HALLS SFREE MENTA 18X12": "7622201802967",
    "HALLS FREE CHERRY": "7622201802875",
    "ALF CHOC TOONIX 16PQX6X300GR": "77939234",
    "ALFAJOR TERRABUSI X 50 GRS.": "77939234",
    "ALF TERRA GLACEADO 48 x 38gr": "7622300202859",
    "ALFAJOR GLACE TOONIX 16X6X38G": "7622300202859",
    "ALF. MILKA MOUSSE LECHE 24x6x42GR.": "7622300759506",
    "ALF. MILKA MOUSSE LECHE  54x42GR.": "7622300759506",
    "ALF SHOT PASTA DE MANI 54X44G": "7622202304705",
    "ALFAJOR TERRABUSI CL√ÅSICO X 70 GRS.": "77903792",
    "ALFAJOR TERRABUSI TORTA X 70 GRS.": "77903860",
    "ALFAJOR MILKA MOUSSE TRIPLE X 55 GRS.": "77903785",
    "ALFAJOR MILKA TRIPLE DULCE DE LECHE X 70 GRS.": "77903778",
    "ALF MILKA TRIMOUSSE BCO 36x55G": "7622300457303",
    "ALFAJOR TRIPLE SHOT X 60 GRS.": "77956699",
    "ALFAJOR TRIPLE PEPITOS X 57 GRS.": "77915481",
    "ALFAJOR MILA OREO DDL": "7622300835620",
    "Alf Triple Oreo 2020 36 X 56 Gr": "77976307",
    "ALF SIMPLE TITA 54X36G": "77908308",
    "MINI ALFAJOR MILKA MOUSSE 16X114G": "7622202220081",
    "MINI ALFAJOR SHOT 16X114G": "7622202223389",
    "TAB CADBURY TRES SUEN 2021 12X12X25": "7622201818579",
    "CADBURY INTENSE 2021 12X12X25G": "7622201818609",
    "TAB CADBURY YOG FRUT 2021 12X12X29": "7622201818654",
    "TAB CADBURY YOG FRUT 2021 28X82G": "7622201818715",
    "TAB CADBURY TRES SUENOS 2021 28X82G": "7622201818739",
    "TAB CADBURY ALMENDRAS 28X82G": "7622201807405",
    "TAB CADBURY INTENSE 24X162G": "7622201800505",
    "TAB CADBURY YOG FRUT 2021 24X162G": "7622201818692",
    "MILKA OREO BOMBON 30DX11UX19G ARG": "77971630",
    "MINI RHODESIA 54X60G": "7622300335090",
    "RHODESIA 12 EST. x 36U. x 22GR.": "77995681",
    "RHODESIA CHOCOLATE 12X36X22G ": "7622201142223",
    "RHODESIA TOONIX 62AGRX4PZX22GR": "77995681",
    "MILKA CHOCOPAUSE REGULAR 4x24x45GR": "7622201492717",
    "MILKA CHOCOPAUSE OREO 4x24x45GR": "7622201492465",
    "HABANITOS 54X60G": "7622300335076",
    "SNACKY 54X60G": "7622300335052",
    "MILKA BIS MILK EXP 65UNX105,6G ": "7622210788207",
    "MILKA BIS OREO 65UNX105,6G EXP": "7622210719829",
    "TITA 2021 AG 69X5X19G": "77976291",
    "TOBLERONE LECHE 20x100GR.": "7614500010013",
    "TOBLERONE 24X35G PACK": "77994066",
    "LILA GO OREO 36CSEX37GR ARG": "7622210828606",
    "MILKA MILK 12DSX20UNX20G EXP": "7622210795625",
    "MILKA DDL 30X67,5G": "7622300844943",
    "MILKA DDL BLANCO 30X 67,5G": "7622300844967",
    "MILKA DDL LECHE 24X135G": "7622300846565",
    "MILKA BLANCO 4DSX21UNX55G EXP": "7622210745583",
    "MILKA LECHE 4DSX21UNX55G EXP": "7622210745224",
    "MILKA LECHE 4X12X150 GRS": "7622300990114",
    "MILKA CHOCO SWING 12 X 300GR": "9012200872739",
    "MILKA ALMENDRAS 4DSX21UNX55G EXP": "7622210745620",
    "MILKA ALMENDRAS 4X12X155G": "7622300990152",
    "MILKA CASTANA 4DSX21UNX55G EXP": "7622210745293",
    "MILKA CASTA√ëAS 4X12X155G": "7622300990183",
    "MILKA OREO BLANCO 12DSX20UNX20G EXP": "7622210795908",
    "MILKA OREO BLANCO 4DSX21UNX55G EXP": "7622210745132",
    "MILKA OREO 22UNX100G": "7622300631574",
    "Milka Oreo Blanco 4X12x155g": "7622300990213",
    "Milka Oreo 300g": "7622210277503",
    "MILKA 95G WHOLE NUTS 17CA": "7622202257599",
    "TAB MILKA LEG B LECH 2021 28X50G": "7622201818937",
    "TAB MILKA LEG B COMB 2021 28X50G": "7622201818951",
    "TAB MILKA LEG ALMEN 2021 28X50G": "7622201818975",
    "TAB MILKA LEG B LECH 2021 24X110G": "7622201812744",
    "TAB MILKA LEG B COMB 2021 24X110G": "7622201812775",
    "TAB MILKA LEG ALM 2021 24X110G": "7622201812805",
    "MILKA LECHE 4DSX21UNX55G VC": "7622210745224",
    "MILKA ALMENDRAS 4DSX21UNX55G VC ": "7622210745620",
    "MILKA LECHE 4DSX12UNX150G VC ": "7622300990114",
    "MILKA ALMENDRAS 4DSX12UNX155G VC": "7622300990152",
    "MILKA  20x90G TRIPLE CHOCOLATE ": "7622210609908",
    "MILKA 20x90G TRIPLE CARAMEL": "7622210609885",
    "MILKA WHOLENUTS 13X270GR": "7622210693266",
    "MKA 300G STRAWB CHEESECAKE 12CA": "7622210678171",
    "MKA OREO BROWNIE 100g 22CA": "7622210953421",
    "MILKA CAR Y AVELL ENT 12X300G": "7622300134532",
    "MKA 100G COOKIES 22CA": "7622201424848",
    "MKA 300G TABLET ALMOND CARAMEL 12CA.": "7622210732507",
    "MKA 100G RASPB 22CA RO": "7622300590062",
    "MKA 250G LUFLEE CARAMEL 10CA": "7622300757717",
    "TAB MILKA DDL LECHE 36X29G": "7622202322068",
    "TAB MILKA DDL BLANCO 36X29G": "7622202322129",
    "MILKA AIREADO LECHE 12X16X25G": "7622202322150",
    "MILKA AIREADO COMBINADO 12X16X25G": "7622202322181",
    "TABLETA SHOT 6x25x35 GR.": "77914217",
    "SHOT 6X25X35G": "77914217",
    "SHOT 20UNX170G 2020 ": "7622300424084",
    " TABLETA SHOT 36X90G VC": "7791249451656",
    "SHOT BLANCO 6DSX25UNX35G EXP": "77983992",
    "TITA 12X36X19G": "77976291",
    "GEL LIGHT FRUTOS ROJOS HS 12X8X25G": "7622300865610",
    "GEL SIN SABOR NEW HS 16X8X14G ": "7622201106034",
    "Polvo para hornear Royal 50G": "7622201464882",
    "POLVO HORNEAR X 100 GR.": "7622300148119",
    "BIZCOCHUELO ROYAL VAINILLA 10X500G ": "7622201806651",
    "BIZCOCHUELO ROYAL CHOCOLATE 10X500G ": "7622201806668",
    "FLAN VAINILLA 6X6X60G ": "7622300871550",
    "MOUSSE LIGHT CHOCO 6X6X40G": "7622300871772",
    "POSTRE CHOCOLATE 6X6X65G ": "7622300989934",
    "POSTRE LIGHT VAINILLA 6X6X43G": "7622300871970",
    "GEL REG FRUTILLA 12X8X25G": "7622201819620",
    "GEL REG FRAMBUESA 12X8X25G": "7622201819668",
    "GEL REG CEREZA 12X8X25G": "7622201819699",
    "GEL REG DURAZNO 12X8X25G": "7622201820534",
    "GEL REG NARANJA 12X8X22G": "7622201820473",
    "GEL LIGHT FRUTILLA 2022 12X8X25G": "7622201820596",
    "GEL LIGHT CEREZA 2022 12X8X25G": "7622201819736",
    "GEL LIGHT FRUT ROJOS 2022 12X8X25G": "7622201820565",
    "FLAN VAINILLA 2022 6X6X60G ": "7622201705268",
    "FLAN LIGHT VAINILLA 2022 6X10X16G ": "7622201705299",
    "MOUSSE CHOCOLATE 2022 6X6X65G ": "7622201706029",
    "MOUSSE LIGHT CHOCO 2022 6X6X40G ": "7622201705138",
    "POSTRE VAINILLA 2022 6X6X75G ": "7622201704643",
    "POSTRE CHOCOLATE 2022 6X6X65G ": "7622201705169",
    "POSTRE FRUTILLA 2022 6X6X75G ": "7622201704674",
    "POSTRE DDL 2022 6X6X75G ": "7622300871949",
    "POSTRE LIGHT VAINILLA 2022 6X6X43G ": "7622201705077",
    "POSTRE LIGHT CHOCO 2022 6X6X50G ": "7622201705107",
    "CREMA CHANTILLY 2022 6X6X50G": "7622201705480",
    "BELDENT MANDARINA 20X20": "77981844",
    "BELDENT SANDIA 20X20 ": "77987686",
    "BELDENT TROPICAL MIX 20X20": "7622202273131",
    "BELDENT MENTA QI POSEIDON 20X20": "77969071",
    "BELDENT MENTA FUERTE QI POSEI 20X20": "77969088",
    "BELDENT MENTOL QI POSEIDON 20X20": "77969095",
    "CH BELDENT GLOBO QI POSEIDON 20X20": "77969101",
    "BELDENT FRUTILLA QI POSEIDON 20X20": "77969118",
    "BELDENT MENTA X7 20X15X13.3G ": "7622201421496",
    "BELD SPEARMINT X7 20X15X13.3G ": "7622201448226",
    "BELD MANDARINA X7 20X15X13.3G ": "7622201448288",
    "BELD BLUEBERRY X7 20X15X13.3G ": "7622201448325",
    "BELDENT INF QI MENTA 14 12X12X26.6G ": "7622201457334",
    "BELD INF QI SPEARM 14 12X12X26.6G ": "7622201457396",
    "BELD INF QI CITRUS 14 12X12X26.6G ": "7622201457426",
    "BELD INF QI BLUEBERRY 14 12X12X26.6G ": "7622201457457",
    "BUBBA MENTA 32DX60UX5G  ": "77982346",
    "BUBBA TUTTI 32DX60UX5G SC": "77982353",
    "BUBBA FRUTILLA 32DX60UX5G SC": "77982360",
    "BUBBA UVA 32DX60UX5G SC": "77982377",
    "CLIGHT LIMO ROSA VITC+D 16X20X7,5G": "7622201682026",
    "CLIGHT ANANA 2022 16X20X7G": "7622201702625",
    "CLIGHT LIMONADA 2022 16X20X8G": "7622201702656",
    "CLIGHT NAR MANGO 2022 16X20X7G": "7622201702687",
    "CLIGHT NAR DURA 2022 16X20X7.5G": "7622201702717",
    "CLIGHT MAN VER 2022 16X20X7.5G": "7622201703059",
    "CLIGHT MANZ DELI 2022 16X20X7G": "7622201703080",
    "CLIGHT LIMO MARACUYA 16X20X7,5G": "7622201733834",
    "CLIGHT NARANJA 2022 16X20X8G": "7622201703110",
    "CLIGHT NAR DUL 2022 16X20X7.5G": "7622201703141",
    "CLIGHT POM ROSA 2022 16X20X8G": "7622201703172",
    "CLIGHT PERA 2022 16X20X7G": "7622201703202",
    "CLIGHT POM AMA 2022 16X20X8G": "7622201703233",
    "CLIGHT MANDARINA 2022 16X20X8G": "7622201704148",
    "CLIGHT NJA STEVIA 2022 16X16X9.5G": "7622201704551",
    "CLIGHT LIMO STEV 2022 16X16X7.5G": "7622201704582",
    "CLIGHT MANZ STEV 2022 16X16X7.5G": "7622201704612",
    "CLIGHT LIMONADA ARANDANOS 16X20X8G": "7622202236846",
    "TANG FRUTILLA 12X20X15G": "7622201746490",
    "TANG NARANJA 12X20X15G": "7622201705961",
    "TANG MANZANA 12X20X15G": "7622201705992",
    "TANG NAR DULCE 12X20X15G": "7622201735340",
    "TANG NAR MANGO 12X20X15G": "7622201735371",
    "TANG LIMO DULCE 12X20X15G": "7622201735685",
    "TANG MULTIFRUTA 12X20X15G": "7622201735715",
    "TANG POM ROSA 12X20X15G": "7622201735746",
    "TANG NAR BANANA 12X20X15G": "7622201735777",
    "TANG NAR DURAZ 12X20X15G": "7622201745707",
    "TANG PERA 12X20X15G": "7622201745738",
    "TANG DURAZNO 12X20X15G": "7622201745936",
    "TANG MIX NAR LIM 12X20X15G": "7622201746018",
    "TANG MIX NJA FRU MAR 12X20X15G": "7622201746063",
    "TANG UVA 12X20X15G": "7622201746117",
    "TANG ANANA 12X20X15G": "7622201745967",
    "TANG MANDARINA 12X20X15G": "7622201733865",
    "VERAO NARANJA 2022 16X20X7G": "7622201717414",
    "VERAO MANZANA 2022 16X20X7G": "7622201717445",
    "VERAO NARANJA DURAZNO 2022 16X20X7G": "7622201717476",
    "VERAO ANANA 2022 16X20X7G": "7622201717506"
}

# -------------------
# üîπ Streamlit UI
# -------------------
st.title("üìä Precios Carrefour - API (Sucursal Hiper Olivos)")
st.write("Obtiene los precios de los productos listados directamente desde la API de Carrefour, aplicando la cookie de **Hiper Olivos**.")

if st.button("üîç Ejecutar scraping"):
    with st.spinner("‚è≥ Procesando... Esto puede tardar unos segundos"):
        resultados = []

        for nombre, product_id in productos.items():
            try:
                url = f"https://www.carrefour.com.ar/api/catalog_system/pub/products/search?fq=productId:{product_id}"
                r = requests.get(url, headers=HEADERS, timeout=10)
                data = r.json()

                if not data:
                    resultados.append({"productId": product_id, "Nombre": nombre, "Precio": "‚ùå Sin datos"})
                    continue

                offer = data[0]['items'][0]['sellers'][0]['commertialOffer']
                price_list = offer.get('ListPrice', 0)
                price = offer.get('Price', 0)

                # Preferimos precio de lista si existe, sino precio actual
                final_price = price_list if price_list > 0 else price

                if final_price > 0:
                    precio_formateado = f"{final_price:,.2f}".replace(",", "X").replace(".", ",").replace("X", "")
                    resultados.append({"productId": product_id, "Nombre": nombre, "Precio": precio_formateado})
                else:
                    resultados.append({"productId": product_id, "Nombre": nombre, "Precio": "no hay stock"})

            except Exception:
                resultados.append({"productId": product_id, "Nombre": nombre, "Precio": "‚ö†Ô∏è Error"})

        # --- Crear DataFrame y mostrarlo
        df = pd.DataFrame(resultados, columns=["productId", "Nombre", "Precio"])
        st.success("‚úÖ Scraping completado v√≠a API")
        st.dataframe(df)

        # --- Bot√≥n de descarga CSV
        fecha = datetime.now().strftime("%Y-%m-%d")
        csv = df.to_csv(index=False).encode('utf-8')
        st.download_button(
            label="‚¨á Descargar CSV",
            data=csv,
            file_name=f"precios_hiper_olivos_{fecha}.csv",
            mime="text/csv",
        )
